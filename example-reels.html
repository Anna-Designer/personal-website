<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Reels â€” Canvas Demo</title>
  <style>
    :root {
      --ui-bg: rgba(0,0,0,0.25);
      --ui-text: #fff;
      --ui-shadow: 0 10px 24px rgba(0,0,0,0.24);
      --ui-radius: 16px;
      --safe-bottom: env(safe-area-inset-bottom, 0px);
    }
    * { box-sizing: border-box; }
    html, body { margin: 0; height: 100%; background: #000; color: var(--ui-text); font-family: system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol"; }
    .reels-stack { height: 100svh; overflow-y: auto; scroll-snap-type: y mandatory; -webkit-overflow-scrolling: touch; }
    .reel { position: relative; height: 100svh; width: 100%; scroll-snap-align: start; scroll-snap-stop: always; display: grid; place-items: center; background: #000; }
    .reel-video { position: absolute; inset: 0; width: 100%; height: 100%; object-fit: cover; }
    .meta { position: absolute; left: 16px; right: 16px; bottom: calc(16px + var(--safe-bottom)); display: grid; gap: 8px; padding: 12px 14px; background: var(--ui-bg); backdrop-filter: blur(8px); border-radius: var(--ui-radius); box-shadow: var(--ui-shadow); }
    .title { margin: 0; font-size: 16px; line-height: 1.25; }
    .caption { margin: 0; font-size: 13px; opacity: 0.9; }
    .progress { position: relative; width: 100%; height: 4px; background: rgba(255,255,255,0.25); border-radius: 999px; overflow: hidden; }
    .progress .bar { display: block; width: 0%; height: 100%; background: #fff; transform-origin: left; }
    .mute-toggle { position: absolute; right: 16px; bottom: calc(96px + var(--safe-bottom)); z-index: 2; width: 44px; height: 44px; border: 0; border-radius: 999px; background: var(--ui-bg); color: var(--ui-text); display: grid; place-items: center; box-shadow: var(--ui-shadow); cursor: pointer; }
    .mute-toggle:focus-visible { outline: 2px solid rgba(255,255,255,0.8); outline-offset: 2px; }
    .mute-toggle[aria-pressed="false"] .mute-icon { filter: none; }
    .mute-toggle[aria-pressed="true"] .mute-icon { filter: grayscale(1) brightness(0.9); }
    @media (prefers-reduced-motion: reduce) { .reels-stack { scroll-snap-type: none; } .reel-video { animation: none !important; } }
  </style>
</head>
<body>
  <main class="reels-stack" id="reels" aria-label="Reels feed">
    <!-- Reel 1 -->
    <section class="reel" id="reel-big-buck-bunny" tabindex="0" aria-label="Big Buck Bunny">
      <video class="reel-video" preload="metadata" playsinline webkit-playsinline muted loop poster="https://storage.googleapis.com/gtv-videos-bucket/sample/images_480x270/BigBuckBunny.jpg" aria-describedby="meta-big-buck-bunny">
        <source src="https://storage.googleapis.com/gtv-videos-bucket/sample/BigBuckBunny.mp4" type="video/mp4" />
        Your device does not support HTML5 video.
      </video>
      <button class="mute-toggle" type="button" aria-pressed="true" aria-label="Unmute">
        <span class="mute-icon" aria-hidden="true">ðŸ”‡</span>
      </button>
      <div class="meta" id="meta-big-buck-bunny">
        <h2 class="title">Big Buck Bunny</h2>
        <p class="caption">Open movie short by the Blender Foundation.</p>
        <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><span class="bar"></span></div>
      </div>
    </section>

    <!-- Reel 2 -->
    <section class="reel" id="reel-elephants-dream" tabindex="0" aria-label="Elephants Dream">
      <video class="reel-video" preload="metadata" playsinline webkit-playsinline muted loop poster="https://storage.googleapis.com/gtv-videos-bucket/sample/images_480x270/ElephantsDream.jpg" aria-describedby="meta-elephants-dream">
        <source src="https://storage.googleapis.com/gtv-videos-bucket/sample/ElephantsDream.mp4" type="video/mp4" />
        Your device does not support HTML5 video.
      </video>
      <button class="mute-toggle" type="button" aria-pressed="true" aria-label="Unmute">
        <span class="mute-icon" aria-hidden="true">ðŸ”‡</span>
      </button>
      <div class="meta" id="meta-elephants-dream">
        <h2 class="title">Elephants Dream</h2>
        <p class="caption">Experimental short â€” surreal, industrial dreamscape.</p>
        <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><span class="bar"></span></div>
      </div>
    </section>

    <!-- Reel 3 -->
    <section class="reel" id="reel-joyrides" tabindex="0" aria-label="For Bigger Joyrides">
      <video class="reel-video" preload="metadata" playsinline webkit-playsinline muted loop poster="https://storage.googleapis.com/gtv-videos-bucket/sample/images_480x270/ForBiggerJoyrides.jpg" aria-describedby="meta-joyrides">
        <source src="https://storage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4" type="video/mp4" />
        Your device does not support HTML5 video.
      </video>
      <button class="mute-toggle" type="button" aria-pressed="true" aria-label="Unmute">
        <span class="mute-icon" aria-hidden="true">ðŸ”‡</span>
      </button>
      <div class="meta" id="meta-joyrides">
        <h2 class="title">For Bigger Joyrides</h2>
        <p class="caption">Chromecast promo clip â€” fast cuts, upbeat pacing.</p>
        <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><span class="bar"></span></div>
      </div>
    </section>

    <!-- Reel 4 -->
    <section class="reel" id="reel-tears-of-steel" tabindex="0" aria-label="Tears of Steel">
      <video class="reel-video" preload="metadata" playsinline webkit-playsinline muted loop poster="https://storage.googleapis.com/gtv-videos-bucket/sample/images_480x270/TearsOfSteel.jpg" aria-describedby="meta-tears">
        <source src="https://storage.googleapis.com/gtv-videos-bucket/sample/TearsOfSteel.mp4" type="video/mp4" />
        Your device does not support HTML5 video.
      </video>
      <button class="mute-toggle" type="button" aria-pressed="true" aria-label="Unmute">
        <span class="mute-icon" aria-hidden="true">ðŸ”‡</span>
      </button>
      <div class="meta" id="meta-tears">
        <h2 class="title">Tears of Steel</h2>
        <p class="caption">Liveâ€‘action + VFX showcase by Blender Foundation.</p>
        <div class="progress" role="progressbar" aria-valuemin="0" aria-valuemax="100" aria-valuenow="0"><span class="bar"></span></div>
      </div>
    </section>
  </main>

  <script>
  (function () {
    const stack = document.getElementById('reels');
    if (!stack) return;

    const reels = Array.from(stack.querySelectorAll('.reel'));
    const videos = reels.map(r => r.querySelector('.reel-video'));

    const allowAutoplay = !window.matchMedia('(prefers-reduced-motion: reduce)').matches;

    // Deep link support â€” scroll to #reel-*
    window.addEventListener('load', () => {
      if (location.hash) {
        const target = document.querySelector(location.hash);
        if (target) target.scrollIntoView({ behavior: 'instant', block: 'start' });
      }
    });

    const io = new IntersectionObserver((entries) => {
      entries.forEach((entry) => {
        const reel = entry.target;
        const video = reel.querySelector('.reel-video');
        if (!video) return;
        if (entry.isIntersecting && entry.intersectionRatio >= 0.6) {
          if (allowAutoplay) safePlay(video);
          reel.dataset.active = "true";
          window.dispatchEvent(new CustomEvent('reel:active', { detail: { id: reel.id } }));
        } else {
          safePause(video);
          reel.dataset.active = "false";
        }
      });
    }, { threshold: [0, 0.6, 1] });

    reels.forEach(r => io.observe(r));

    // Mute toggle handling
    stack.addEventListener('click', (e) => {
      const btn = e.target.closest('.mute-toggle');
      if (!btn) return;
      const reel = btn.closest('.reel');
      const video = reel.querySelector('.reel-video');
      const currentlyMuted = video.muted;
      video.muted = !currentlyMuted;
      btn.setAttribute('aria-pressed', String(video.muted));
      btn.querySelector('.mute-icon').textContent = video.muted ? 'ðŸ”‡' : 'ðŸ”Š';
      window.dispatchEvent(new CustomEvent('reel:mute', { detail: { id: reel.id, muted: video.muted } }));
    });

    // Progress bar updates
    videos.forEach((video) => {
      const reel = video.closest('.reel');
      const bar = reel.querySelector('.progress .bar');
      const pb = reel.querySelector('.progress');
      const updateProgress = () => {
        if (!video.duration || !isFinite(video.duration)) return;
        const pct = (video.currentTime / video.duration) * 100;
        bar.style.width = pct.toFixed(2) + '%';
        pb.setAttribute('aria-valuenow', Math.min(100, Math.max(0, Math.round(pct))).toString());
      };
      video.addEventListener('timeupdate', updateProgress);
      video.addEventListener('seeking', updateProgress);
      video.addEventListener('loadedmetadata', updateProgress);
      video.addEventListener('ended', () => {
        window.dispatchEvent(new CustomEvent('reel:ended', { detail: { id: reel.id } }));
      });
    });

    // Keyboard navigation
    window.addEventListener('keydown', (e) => {
      if (e.key !== 'ArrowDown' && e.key !== 'ArrowUp') return;
      e.preventDefault();
      const dir = e.key === 'ArrowDown' ? 1 : -1;
      snapToRelative(dir);
    });

    // Touch swipe navigation
    let touchStartY = null;
    stack.addEventListener('touchstart', (e) => {
      touchStartY = e.changedTouches[0].clientY;
    }, { passive: true });
    stack.addEventListener('touchend', (e) => {
      if (touchStartY === null) return;
      const dy = e.changedTouches[0].clientY - touchStartY;
      touchStartY = null;
      const threshold = 48;
      if (Math.abs(dy) < threshold) return;
      snapToRelative(dy > 0 ? -1 : 1);
    }, { passive: true });

    function snapToRelative(delta) {
      const active = reels.findIndex(r => r.dataset.active === "true");
      const nextIndex = Math.min(reels.length - 1, Math.max(0, active + delta));
      const target = reels[nextIndex];
      if (!target) return;
      target.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function safePlay(video) {
      if (video.readyState >= 2) {
        video.play().catch(() => {});
      } else {
        const onCanPlay = () => { video.play().catch(() => {}); video.removeEventListener('canplay', onCanPlay); };
        video.addEventListener('canplay', onCanPlay);
        video.load();
      }
    }
    function safePause(video) { try { video.pause(); } catch (_) {} }

    // Preload the next reel opportunistically
    const preloadNext = new IntersectionObserver((entries) => {
      entries.forEach(entry => {
        if (entry.isIntersecting) {
          const reel = entry.target;
          const next = reel.nextElementSibling;
          if (!next) return;
          const nextVideo = next.querySelector('.reel-video');
          if (nextVideo && nextVideo.preload !== 'auto') {
            nextVideo.preload = 'auto';
          }
        }
      });
    }, { threshold: 0.9 });
    reels.forEach(r => preloadNext.observe(r));
  })();
  </script>
</body>
</html>
